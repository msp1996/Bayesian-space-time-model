### simulated data generation

library(MASS)

N=159
T=8
E=matrix(rgamma(N*T,1,1),N,T)  ##expected count: eij~gamma(1,1)
# E_sim=matrix(runif(N*T,1,5),N,T)  ##expected count: eij~ U(1,5)

U=rnorm(N,0,0.05)   ##spatial uncorrelated random component: u_i
V=mvrnorm(1,rep(0,N),0.05^2*ginv(B_1))   ##spatial correlated random component: v_i



num= c(6, 5, 5, 6, 5, 6, 6, 7, 5, 7, 
       6, 6, 6, 4, 5, 7, 5, 6, 6, 3, 
       5, 6, 2, 3, 2, 5, 3, 7, 5, 4, 
       5, 4, 5, 8, 6, 3, 5, 7, 5, 6, 
       1, 7, 5, 5, 6, 6, 6, 4, 5, 3, 
       4, 5, 10, 5, 5, 4, 4, 5, 4, 10, 
       6, 4, 4, 9, 3, 6, 7, 6, 9, 7, 
       3, 4, 3, 3, 6, 7, 5, 6, 6, 7, 
       8, 4, 6, 7, 5, 5, 7, 5, 5, 4, 
       4, 5, 6, 6, 7, 6, 7, 4, 7, 4, 
       7, 7, 5, 6, 4, 3, 6, 7, 7, 6, 
       5, 5, 5, 4, 4, 5, 6, 3, 2, 6, 
       4, 5, 4, 4, 3, 8, 3, 4, 8, 7, 
       6, 8, 7, 6, 6, 4, 6, 7, 4, 6, 
       4, 6, 6, 4, 7, 5, 6, 7, 6, 6, 
       7, 6, 6, 5, 4, 7, 6, 7, 7)

adj = c(
  151, 138, 132, 113, 80, 3, 
  148, 86, 34, 32, 10, 
  148, 113, 80, 34, 1, 
  101, 100, 49, 47, 44, 19, 
  158, 150, 117, 84, 70, 
  127, 95, 78, 69, 68, 59, 
  147, 108, 78, 69, 67, 29, 
  115, 112, 110, 64, 57, 33, 28, 
  156, 142, 134, 77, 34, 
  137, 92, 86, 77, 37, 34, 2, 
  143, 111, 102, 84, 76, 39, 
  158, 143, 116, 87, 76, 45, 
  151, 148, 113, 63, 24, 20, 
  136, 92, 37, 35, 
  89, 54, 51, 25, 16, 
  124, 82, 54, 53, 51, 21, 15, 
  124, 121, 82, 81, 53, 
  126, 107, 102, 85, 79, 75, 
  135, 120, 49, 47, 30, 4, 
  63, 24, 13, 
  138, 132, 54, 53, 16, 
  110, 74, 71, 60, 48, 38, 
  155, 146, 
  148, 20, 13, 
  51, 15, 
  152, 130, 128, 106, 96, 
  146, 64, 57, 
  112, 64, 60, 58, 42, 33, 8, 
  109, 108, 95, 78, 7, 
  120, 118, 49, 19, 
  126, 75, 60, 56, 43, 
  148, 86, 50, 2, 
  110, 60, 48, 28, 8, 
  148, 134, 80, 77, 10, 9, 3, 2, 
  159, 137, 136, 101, 37, 14, 
  121, 97, 90, 
  137, 92, 35, 14, 10, 
  141, 126, 99, 74, 60, 56, 22, 
  145, 133, 111, 102, 11, 
  159, 156, 142, 129, 88, 46, 
  146, 
  112, 93, 69, 61, 58, 55, 28, 
  122, 75, 67, 60, 31, 
  125, 101, 100, 65, 4, 
  156, 153, 134, 116, 87, 12, 
  156, 129, 116, 94, 76, 40, 
  159, 135, 101, 88, 19, 4, 
  110, 60, 33, 22, 
  125, 100, 30, 19, 4, 
  92, 86, 32, 
  124, 25, 16, 15, 
  157, 109, 95, 90, 73, 
  140, 138, 132, 103, 83, 82, 81, 21, 17, 16, 
  132, 89, 21, 16, 15, 
  144, 105, 93, 61, 42, 
  126, 60, 38, 31, 
  115, 64, 27, 8, 
  69, 67, 60, 42, 28, 
  127, 95, 73, 6, 
  67, 58, 56, 48, 43, 38, 33, 31, 28, 22, 
  112, 105, 93, 64, 55, 42, 
  150, 149, 81, 70, 
  151, 98, 20, 13, 
  155, 146, 112, 105, 61, 57, 28, 27, 8, 
  136, 101, 44, 
  131, 117, 109, 108, 104, 70, 
  147, 122, 69, 60, 58, 43, 7, 
  154, 139, 127, 119, 69, 6, 
  154, 93, 78, 68, 67, 58, 42, 7, 6, 
  150, 149, 131, 117, 66, 62, 5, 
  115, 110, 22, 
  141, 130, 106, 99, 
  95, 59, 52, 
  141, 38, 22, 
  126, 122, 107, 43, 31, 18, 
  143, 116, 111, 94, 46, 12, 11, 
  142, 137, 34, 10, 9, 
  108, 95, 69, 29, 7, 6, 
  117, 107, 104, 102, 84, 18, 
  153, 138, 134, 103, 34, 3, 1, 
  150, 149, 121, 97, 83, 62, 53, 17, 
  124, 53, 17, 16, 
  158, 150, 140, 87, 81, 53, 
  158, 143, 117, 102, 79, 11, 5, 
  145, 126, 114, 102, 18, 
  92, 50, 32, 10, 2, 
  158, 153, 143, 140, 83, 45, 12, 
  159, 135, 129, 47, 40, 
  132, 98, 91, 54, 15, 
  157, 97, 52, 36, 
  151, 132, 98, 89, 
  86, 50, 37, 14, 10, 
  154, 144, 69, 61, 55, 42, 
  133, 129, 123, 111, 76, 46, 
  109, 78, 73, 59, 52, 29, 6, 
  152, 133, 130, 129, 123, 26, 
  157, 149, 131, 121, 90, 81, 36, 
  151, 91, 89, 63, 
  145, 141, 130, 126, 114, 72, 38, 
  125, 49, 44, 4, 
  159, 136, 65, 47, 44, 35, 4, 
  145, 85, 84, 79, 39, 18, 11, 
  153, 140, 138, 80, 53, 
  147, 117, 108, 107, 79, 66, 
  155, 64, 61, 55, 
  130, 72, 26, 
  147, 122, 104, 79, 75, 18, 
  147, 109, 104, 78, 66, 29, 7, 
  157, 131, 108, 95, 66, 52, 29, 
  115, 71, 48, 33, 22, 8, 
  133, 94, 76, 39, 11, 
  64, 61, 42, 28, 8, 
  151, 148, 13, 3, 1, 
  145, 126, 99, 85, 
  110, 71, 57, 8, 
  156, 76, 46, 45, 12, 
  104, 84, 79, 70, 66, 5, 
  128, 120, 30, 
  139, 68, 
  152, 135, 128, 118, 30, 19, 
  97, 81, 36, 17, 
  147, 107, 75, 67, 43, 
  133, 129, 96, 94, 
  82, 51, 17, 16, 
  100, 49, 44, 
  114, 99, 85, 75, 56, 38, 31, 18, 
  68, 59, 6, 
  152, 120, 118, 26, 
  152, 135, 123, 96, 94, 88, 46, 40, 
  145, 133, 106, 99, 96, 72, 26, 
  157, 149, 109, 97, 70, 66, 
  151, 138, 91, 89, 54, 53, 21, 1, 
  145, 130, 123, 111, 96, 94, 39, 
  156, 153, 80, 45, 34, 9, 
  152, 129, 120, 88, 47, 19, 
  101, 65, 35, 14, 
  159, 142, 77, 37, 35, 10, 
  140, 132, 103, 80, 53, 21, 1, 
  154, 144, 119, 68, 
  153, 138, 103, 87, 83, 53, 
  99, 74, 72, 38, 
  159, 156, 137, 77, 40, 9, 
  158, 87, 84, 76, 12, 11, 
  154, 139, 93, 55, 
  133, 130, 114, 102, 99, 85, 39, 
  155, 64, 41, 27, 23, 
  122, 108, 107, 104, 67, 7, 
  113, 34, 32, 24, 13, 3, 2, 
  157, 131, 97, 81, 70, 62, 
  158, 83, 81, 70, 62, 5, 
  132, 113, 98, 91, 63, 13, 1, 
  135, 129, 128, 120, 96, 26, 
  140, 134, 103, 87, 80, 45, 
  144, 139, 93, 69, 68, 
  146, 105, 64, 23, 
  142, 134, 116, 46, 45, 40, 9, 
  149, 131, 109, 97, 90, 52, 
  150, 143, 87, 84, 83, 12, 5, 
  142, 137, 101, 88, 47, 40, 35)


B_1 = diag( num)

for (j in adj[1:num[1]]) {
  B_1[1,j]=-1    #µÚÒ»ÐÐ
}

for (i in 2:N) {
  for (j in adj[(sum(num[1:(i-1)])+1):sum(num[1:i])]) {
    B_1[i,j]=-1
  }
  
}   


##covariates
X1=matrix(rnorm(N*T,0,0.2),N,T)
X2=matrix(rnorm(N*T,0,0.2),N,T)
X3=matrix(rnorm(N*T,0,0.2),N,T)
X4=matrix(rnorm(N*T,0,0.1),N,T)   # +V


##coefficients

##spatial clusters
# C[i]
S=6

c1=c(41,146,23,155,105,55,61,27,64,57,8,42,58,110,115,71,33,60,48,22,43,74,38,56,31,75,122,72,106)
c2=c(144,139,119,93,154,68,127,69,59,6,73,52,95,78,67,7,29,109,157,108,147,90,107,28,112)
c3=c(141,156, 45, 128, 152, 129, 46, 116, 12, 79, 84, 143,  123, 26, 96, 11, 39, 133, 130, 145, 18, 102, 85, 114, 126, 99)
c4=c(51, 140, 87, 83, 21, 53, 16,  81, 17, 121, 62, 150, 158, 5, 117, 70, 149, 36, 97, 131, 66, 104)
c5=c(148,76,94,111,118,92, 10, 77, 9, 40, 142, 137, 37, 14, 136, 35, 65, 125, 44, 101, 4, 100, 49, 19, 47, 159, 88, 135, 120, 30,86)
c6=c(124, 82,34,32, 54, 132, 138, 103, 153, 134, 13, 63, 98, 25, 15, 89, 91, 151, 113, 20, 24, 50,  80, 3, 2, 1)


C=rep(0,159)
for(i in c1){
  C[i]=1
}
for(i in c2){
  C[i]=2
}
for(i in c3){
  C[i]=3
}
for(i in c4){
  C[i]=4
}
for(i in c5){
  C[i]=5
}
for(i in c6){
  C[i]=6
}

###variable selection: set delta
delta=matrix(c(1,1,0,1,0,1,1,0,1,1,0,1,0,1,1,0,1,1,0,0,0,1,1,0),S,4)


#####  temporal trends of coefficients
#################### ar(1)

lamda=array(rep(0,S*T*4),c(S,T,4))
lamda[,1,1]=c(-1,1,1.5,0.5,0,1)
lamda[,1,2]=c(1,-1,-1.5,-0.5,0,1)
lamda[,1,3]=c(-1,-1,1.5,-0.5,0,1)
lamda[,1,4]=c(1,-1,1,-0.5,0,-1)
rho=c(0.8,0.7,0.6,0.5,0.4,0.3)

for (j in 1:4) {
 for(s in 1:S){
  for (i in 1:(T-1)) {
    lamda[s,i+1,j]=rnorm(1, rho[s]*lamda[s,i,j],1 )    ##AR(1)
  }
}
}

##random walk
for (j in 1:4) {
  for(s in 1:S){
    for (i in 1:(T-1)) {
      lamda[s,i+1,j]=rnorm(1,lamda[s,i,j],1 )    ##random walk
    }
  }
}

plot(lamda[1,,1],type="l")


#####  coefficients
beta=array(rep(0,S*T*4),dim = c(S,T,4))

for(s in 1:S){
  for(t in 1:T){
    for(p in 1:4){
      beta[s,t,p]= delta[s,p]*lamda[s,t,p]
    }
  }
}

###  risk model
theta=matrix(0,N,T)
for (i in 1:N) {
  for (t in 1:T) {
    theta[i,t]=exp(beta[C[i],t,1]*X1[i,t] + beta[C[i],t,2]*X2[i,t] +beta[C[i],t,3]*X3[i,t] +beta[C[i],t,4]*X4[i,t] )
    #   + U[i]+V[i]
  }
}



Y=matrix(0,N,T)
for (i in 1:N) {
  for (t in 1:T) {
    Y[i,t]=rpois(1,E[i,t]*theta[i,t])
  }
}
##

############################## winbugs 

#winbugs model file
sim.file <- "C:/Users/msp/Desktop/sim_winbugs.txt"    ### path
# Let's take a look:
file.show(sim.file)   


sumNumNeigh = 860

data <- list ("Y", "X1","X2", "X3", "X4", "E","sumNumNeigh","N","T","S", "num","adj"  )

P=4
CC=rmultinom(N, size = 1, prob = rep(1/S,S))  ##multinomial distribution,initials generation
C0=NULL
for(i in 1:N){
  C0=rbind(C0,which(CC[,i]==1))
}

inits <- function()
  list (beta0=0,  delta=matrix(rbinom(P*S,1,0.5),S,P),C=as.vector(C0),w_star=matrix(rep(1,N*S),S,N),alpha=0,
        eta=matrix(rep(0,N*S),S,N), sigma.eta=rep(0.1,S),sigma.wstar=rep(0.1,S),
        mu=c(0,0,0,0),xi=matrix(rep(0,P*S),S,P),sigma.xi=matrix(rep(0.1,P*S),S,P),
        lamda=array(rnorm(S*T*P,0,5),c(S,P,T)),sigma.lamd=1)

parameters <- c("beta0","delta","C","delta","alpha","eta","sigma.eta","sigma.det","mu","xi","siSma.xi","lamda","sigma.lamd")

sim <- bugs (data, inits, parameters, sim.file,
             n.chains=1,
             n.iter=50000,n.burnin=20000,DIC=TRUE,
             bugs.directory="E:/winbugs143_unrestricted/winbugs14_full_patched/WinBUGS14/",debug=TRUE)
print(sim)
plot(sim)


